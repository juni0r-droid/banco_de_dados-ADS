CREATE DATABASE LANHOUSE


-- ========================
-- 1. TABELAS
-- ========================

CREATE TABLE CLIENTE (
    ID_CLIENTE INT PRIMARY KEY,
    NOME_CLIENTE VARCHAR(100) NOT NULL,
    CPF VARCHAR(11) NOT NULL
);

CREATE TABLE FUNCIONARIO (
    ID_FUNCIONARIO INT PRIMARY KEY,
    NOME_FUNCIONARIO VARCHAR(100) NOT NULL,
    CARGO VARCHAR(50) NOT NULL
);

CREATE TABLE COMPUTADOR (
    ID_COMPUTADOR INT PRIMARY KEY,
    MODELO VARCHAR(50) NOT NULL,
    STATUS VARCHAR(20) NOT NULL
);

CREATE TABLE PRODUTO (
    ID_PRODUTO INT PRIMARY KEY,
    NOME_PRODUTO VARCHAR(100) NOT NULL,
    PRECO DECIMAL(8,2) NOT NULL
);

CREATE TABLE PEDIDO (
    ID_PEDIDO INT PRIMARY KEY,
    ID_CLIENTE INT NOT NULL,
    VALOR_TOTAL DECIMAL(8,2) NOT NULL,
    DATA_PEDIDO DATE NOT NULL
);

CREATE TABLE ITEM_PEDIDO (
    ID_ITEM INT PRIMARY KEY,
    ID_PEDIDO INT NOT NULL,
    ID_PRODUTO INT NOT NULL,
    QUANTIDADE INT NOT NULL
);

-- ========================
-- 2. INSERÇÃO DE DADOS
-- ========================

-- CLIENTES
INSERT INTO CLIENTE VALUES (1, 'JOÃO SILVA', '12345678901');
INSERT INTO CLIENTE VALUES (2, 'MARIA SOUZA', '23456789012');
INSERT INTO CLIENTE VALUES (3, 'CARLOS LIMA', '34567890123');
INSERT INTO CLIENTE VALUES (4, 'RODRIGO FARO', '54567890123');

-- FUNCIONÁRIOS
INSERT INTO FUNCIONARIO VALUES (1, 'ANA COSTA', 'ATENDENTE');
INSERT INTO FUNCIONARIO VALUES (2, 'PEDRO SANTOS', 'GERENTE');

-- COMPUTADORES
INSERT INTO COMPUTADOR VALUES (1, 'DELL', 'DISPONÍVEL');
INSERT INTO COMPUTADOR VALUES (2, 'HP', 'EM USO');

-- PRODUTOS
INSERT INTO PRODUTO VALUES (1, 'REFRIGERANTE', 5.00);
INSERT INTO PRODUTO VALUES (2, 'SALGADINHO', 3.50);
INSERT INTO PRODUTO VALUES (3, 'MOUSE GAMER', 120.00);

-- PEDIDOS
INSERT INTO PEDIDO VALUES (1, 1, 8.50, '2025-09-01');
INSERT INTO PEDIDO VALUES (2, 2, 123.50, '2025-09-01');
INSERT INTO PEDIDO VALUES (3, 3, 3.50, '2025-09-01');

-- ITENS DO PEDIDO
INSERT INTO ITEM_PEDIDO VALUES (1, 1, 1, 1);
INSERT INTO ITEM_PEDIDO VALUES (2, 1, 2, 1);
INSERT INTO ITEM_PEDIDO VALUES (3, 2, 3, 1);
INSERT INTO ITEM_PEDIDO VALUES (4, 3, 2, 1);

-- ========================
-- 3. FUNÇÕES COM 4 PARÂMETROS
-- ========================

-- FUNÇÃO ESCALAR
GO
CREATE FUNCTION FN_TOTALGASTOCLIENTEPERIODO(
    @ID_CLIENTE INT,
    @VALOR_MIN DECIMAL(8,2),
    @DATA_INICIO DATE,
    @DATA_FIM DATE
)
RETURNS DECIMAL(8,2)
AS
BEGIN
    DECLARE @TOTAL DECIMAL(8,2)
    SELECT @TOTAL = SUM(VALOR_TOTAL)
    FROM PEDIDO
    WHERE ID_CLIENTE = @ID_CLIENTE
      AND VALOR_TOTAL >= @VALOR_MIN
      AND DATA_PEDIDO BETWEEN @DATA_INICIO AND @DATA_FIM
    RETURN ISNULL(@TOTAL,0)
END
GO

-- FUNÇÃO TABELA
GO
CREATE FUNCTION FN_LISTAPEDIDOSCLIENTEFILTRO(
    @ID_CLIENTE INT,
    @VALOR_MIN DECIMAL(8,2),
    @DATA_INICIO DATE,
    @DATA_FIM DATE
)
RETURNS TABLE
AS
RETURN (
    SELECT P.ID_PEDIDO, P.VALOR_TOTAL, I.ID_PRODUTO, I.QUANTIDADE
    FROM PEDIDO P
    JOIN ITEM_PEDIDO I ON P.ID_PEDIDO = I.ID_PEDIDO
    WHERE P.ID_CLIENTE = @ID_CLIENTE
      AND P.VALOR_TOTAL >= @VALOR_MIN
      AND P.DATA_PEDIDO BETWEEN @DATA_INICIO AND @DATA_FIM
)
GO

-- ========================
-- 4. VIEWS  
-- ========================

-- VIEW 1: CLIENTES COM PEDIDOS
GO
CREATE VIEW VW_CLIENTESPEDIDOS AS
SELECT C.NOME_CLIENTE, P.ID_PEDIDO, P.VALOR_TOTAL
FROM CLIENTE C
JOIN PEDIDO P ON C.ID_CLIENTE = P.ID_CLIENTE;
GO
-- VIEW 2: PRODUTOS DISPONÍVEIS
GO
CREATE VIEW VW_PRODUTOS AS
SELECT * FROM PRODUTO;
GO
-- VIEW 3: PEDIDOS DETALHADOS
GO
CREATE VIEW VW_PEDIDOSDETALHADOS AS
SELECT P.ID_PEDIDO, C.NOME_CLIENTE, I.ID_PRODUTO, I.QUANTIDADE, P.VALOR_TOTAL
FROM PEDIDO P
JOIN CLIENTE C ON P.ID_CLIENTE = C.ID_CLIENTE
JOIN ITEM_PEDIDO I ON P.ID_PEDIDO = I.ID_PEDIDO;
GO
-- VIEW 4: CLIENTES SEM PEDIDOS
GO
CREATE VIEW VW_CLIENTESSEMPEDIDOS AS
SELECT C.NOME_CLIENTE
FROM CLIENTE C
LEFT JOIN PEDIDO P ON C.ID_CLIENTE = P.ID_CLIENTE
WHERE P.ID_PEDIDO IS NULL;
GO
-- VIEW 5: PRODUTOS CAROS
GO
CREATE VIEW VW_PRODUTOSCAROS AS
SELECT * FROM PRODUTO
WHERE PRECO > 100;
GO
-- ========================
-- 5. TESTES 
-- ========================

-- TESTANDO FUNÇÃO ESCALAR
SELECT dbo.FN_TOTALGASTOCLIENTEPERIODO(1, 5, '2025-01-01', '2025-12-31') AS TOTAL_JOAO;
SELECT dbo.FN_TOTALGASTOCLIENTEPERIODO(2, 50, '2025-01-01', '2025-12-31') AS TOTAL_MARIA;

-- TESTANDO FUNÇÃO TABELA
SELECT * FROM dbo.FN_LISTAPEDIDOSCLIENTEFILTRO(1, 5, '2025-01-01', '2025-12-31');
SELECT * FROM dbo.FN_LISTAPEDIDOSCLIENTEFILTRO(2, 50, '2025-01-01', '2025-12-31');

-- TESTANDO VIEWS
SELECT * FROM VW_CLIENTESPEDIDOS;
SELECT * FROM VW_PRODUTOS;
SELECT * FROM VW_PEDIDOSDETALHADOS;
SELECT * FROM VW_CLIENTESSEMPEDIDOS;
SELECT * FROM VW_PRODUTOSCAROS;
